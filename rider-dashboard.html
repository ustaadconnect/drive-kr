<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - DriveKar</title>
    
    <!-- Firebase SDK -->
    <script type="module" src="/assets/js/firebase-config.js"></script>
    
    <!-- Styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/style.css">
    
    <style>
        .stats-card {
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
        }
        .stats-card.rides { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stats-card.spent { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stats-card.saved { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stats-card.rating { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        
        .quick-action-card {
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            height: 100%;
        }
        .quick-action-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.1);
        }
        
        .ride-card {
            border-left: 4px solid;
            margin-bottom: 15px;
        }
        .ride-card.pending { border-left-color: #f59e0b; }
        .ride-card.active { border-left-color: #10b981; }
        .ride-card.completed { border-left-color: #3b82f6; }
        .ride-card.cancelled { border-left-color: #ef4444; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-car"></i> DriveKar
            </a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle"></i> User
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/pages/profile.html">
                            <i class="fas fa-user"></i> Profile
                        </a></li>
                        <li><a class="dropdown-item" href="/pages/wallet.html">
                            <i class="fas fa-wallet"></i> Wallet
                        </a></li>
                        <li><a class="dropdown-item" href="/pages/rides.html">
                            <i class="fas fa-history"></i> Ride History
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Welcome Banner -->
        <div class="alert alert-primary">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-1">Welcome back, <span id="userName">User</span>!</h4>
                    <p class="mb-0">Ready for your next ride? Book now and save with bid-based pricing.</p>
                </div>
                <button class="btn btn-light" onclick="window.location.href='/pages/book-ride.html'">
                    <i class="fas fa-plus"></i> Book New Ride
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3 col-6">
                <div class="stats-card rides">
                    <h2 id="totalRides">0</h2>
                    <p class="mb-0">Total Rides</p>
                    <small><i class="fas fa-history"></i> All time</small>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stats-card spent">
                    <h2 id="totalSpent">Rs 0</h2>
                    <p class="mb-0">Total Spent</p>
                    <small><i class="fas fa-money-bill-wave"></i> All rides</small>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stats-card saved">
                    <h2 id="totalSaved">Rs 0</h2>
                    <p class="mb-0">Total Saved</p>
                    <small><i class="fas fa-piggy-bank"></i> Through bidding</small>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stats-card rating">
                    <h2 id="userRating">0.0</h2>
                    <p class="mb-0">Your Rating</p>
                    <small><i class="fas fa-star"></i> From drivers</small>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-md-3 col-6 mb-3">
                <div class="quick-action-card" onclick="window.location.href='/pages/book-ride.html'">
                    <i class="fas fa-map-marker-alt fa-3x text-primary mb-3"></i>
                    <h5>Book Ride</h5>
                    <p class="text-muted small">Set your price and get bids</p>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="quick-action-card" onclick="window.location.href='/pages/wallet.html'">
                    <i class="fas fa-wallet fa-3x text-success mb-3"></i>
                    <h5>My Wallet</h5>
                    <p class="text-muted small">Add funds & view transactions</p>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="quick-action-card" onclick="window.location.href='/pages/rides.html'">
                    <i class="fas fa-history fa-3x text-info mb-3"></i>
                    <h5>Ride History</h5>
                    <p class="text-muted small">View past rides & receipts</p>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="quick-action-card" onclick="window.location.href='/pages/support.html'">
                    <i class="fas fa-headset fa-3x text-warning mb-3"></i>
                    <h5>Support</h5>
                    <p class="text-muted small">Get help & contact admin</p>
                </div>
            </div>
        </div>

        <!-- Active Rides -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-bolt"></i> Active Rides
                </h5>
                <span class="badge bg-primary" id="activeRidesCount">0 Active</span>
            </div>
            <div class="card-body">
                <div id="activeRidesList">
                    <div class="text-center py-4">
                        <i class="fas fa-car fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No active rides</p>
                        <button class="btn btn-primary" onclick="window.location.href='/pages/book-ride.html'">
                            Book Your First Ride
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Rides -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history"></i> Recent Rides
                </h5>
            </div>
            <div class="card-body">
                <div id="recentRidesList">
                    <div class="ride-card completed p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Satellite Town → Model Town</h6>
                                <small class="text-muted">
                                    <i class="fas fa-car"></i> Car • 
                                    <i class="fas fa-user"></i> Driver: Ali • 
                                    <i class="fas fa-star text-warning"></i> 4.8
                                </small>
                            </div>
                            <div class="text-end">
                                <h5 class="text-primary mb-1">Rs 450</h5>
                                <small class="text-muted">Today, 10:30 AM</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ride-card completed p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Peoples Colony → Railway Road</h6>
                                <small class="text-muted">
                                    <i class="fas fa-motorcycle"></i> Bike • 
                                    <i class="fas fa-user"></i> Driver: Ahmed • 
                                    <i class="fas fa-star text-warning"></i> 4.5
                                </small>
                            </div>
                            <div class="text-end">
                                <h5 class="text-primary mb-1">Rs 200</h5>
                                <small class="text-muted">Yesterday, 3:45 PM</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <a href="/pages/rides.html" class="btn btn-outline-primary">
                        <i class="fas fa-list"></i> View All Rides
                    </a>
                </div>
            </div>
        </div>

        <!-- Driver Promotion (for non-drivers) -->
        <div class="card bg-light mb-4" id="driverPromotion" style="display: none;">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="text-success">
                            <i class="fas fa-id-card"></i> Want to earn with your vehicle?
                        </h5>
                        <p class="mb-0">Become a DriveKar driver and start earning money. No fixed hours, work when you want.</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-success" onclick="becomeDriver()">
                            <i class="fas fa-user-plus"></i> Become a Driver
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Support Information -->
        <div class="alert alert-info">
            <h6><i class="fas fa-headset"></i> Need Help?</h6>
            <div class="row">
                <div class="col-md-4">
                    <p class="mb-1"><strong>General Support:</strong></p>
                    <a href="https://wa.me/923229814170" class="text-decoration-none">
                        <i class="fab fa-whatsapp text-success"></i> 0322-9814170
                    </a>
                </div>
                <div class="col-md-4">
                    <p class="mb-1"><strong>Payment Issues:</strong></p>
                    <a href="https://wa.me/923429774490" class="text-decoration-none">
                        <i class="fab fa-whatsapp text-success"></i> 0342-9774490
                    </a>
                </div>
                <div class="col-md-4">
                    <p class="mb-1"><strong>Emergency:</strong></p>
                    <a href="tel:03229814170" class="text-decoration-none">
                        <i class="fas fa-phone text-danger"></i> 0322-9814170
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { auth, db } from "/assets/js/firebase-config.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        
        // Check authentication
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log('User logged in:', user.uid);
                await loadUserData(user.uid);
                await loadActiveRides(user.uid);
                checkIfDriver(user.uid);
            } else {
                window.location.href = '/pages/login.html';
            }
        });
        
        async function loadUserData(userId) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    
                    // Update user name
                    document.getElementById('userName').textContent = userData.fullName || 'User';
                    
                    // Update stats
                    document.getElementById('totalRides').textContent = userData.totalRides || 0;
                    document.getElementById('totalSpent').textContent = `Rs ${userData.totalSpent || 0}`;
                    document.getElementById('totalSaved').textContent = `Rs ${userData.totalSaved || 0}`;
                    document.getElementById('userRating').textContent = userData.rating?.toFixed(1) || '0.0';
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        
        async function loadActiveRides(userId) {
            try {
                const ridesQuery = query(
                    collection(db, 'rides'),
                    where('riderId', '==', userId),
                    where('status', 'in', ['pending', 'bidding', 'accepted', 'active'])
                );
                
                const querySnapshot = await getDocs(ridesQuery);
                const activeRidesList = document.getElementById('activeRidesList');
                const activeRidesCount = document.getElementById('activeRidesCount');
                
                if (querySnapshot.empty) {
                    activeRidesCount.textContent = '0 Active';
                } else {
                    activeRidesCount.textContent = `${querySnapshot.size} Active`;
                    activeRidesList.innerHTML = '';
                    
                    querySnapshot.forEach((doc) => {
                        const ride = doc.data();
                        activeRidesList.innerHTML += createRideCard(ride);
                    });
                }
            } catch (error) {
                console.error('Error loading active rides:', error);
            }
        }
        
        function createRideCard(ride) {
            const statusColors = {
                'pending': 'warning',
                'bidding': 'info',
                'accepted': 'success',
                'active': 'primary',
                'completed': 'secondary',
                'cancelled': 'danger'
            };
            
            const statusText = {
                'pending': 'Pending',
                'bidding': 'Bidding Open',
                'accepted': 'Driver Assigned',
                'active': 'Active',
                'completed': 'Completed',
                'cancelled': 'Cancelled'
            };
            
            return `
                <div class="ride-card ${ride.status} p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${ride.pickup?.area || 'Pickup'} → ${ride.destination?.area || 'Destination'}</h6>
                            <small class="text-muted">
                                <i class="fas fa-car"></i> ${ride.vehicleType || 'Vehicle'} • 
                                <span class="badge bg-${statusColors[ride.status]}">${statusText[ride.status]}</span>
                            </small>
                        </div>
                        <div class="text-end">
                            <h5 class="text-primary mb-1">Rs ${ride.maxPrice || 0}</h5>
                            <small class="text-muted">
                                ${new Date(ride.createdAt?.toDate()).toLocaleDateString()}
                            </small>
                            <div class="mt-1">
                                <a href="/pages/ride-bids.html?rideId=${ride.id || ''}" class="btn btn-sm btn-primary">
                                    View Details
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function checkIfDriver(userId) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    if (userData.accountType !== 'driver') {
                        document.getElementById('driverPromotion').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error checking driver status:', error);
            }
        }
        
        function becomeDriver() {
            if (confirm('Do you want to become a driver? This will require document verification.')) {
                window.location.href = '/pages/driver-registration.html';
            }
        }
        
        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = '/pages/login.html';
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout failed: ' + error.message);
            }
        });
    </script>
</body>
</html>